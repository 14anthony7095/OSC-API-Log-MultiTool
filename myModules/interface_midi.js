var JZZ = require('jzz');

// function lerp(start, end, factor) { return start + (end - start) * factor; }

async function playNote(chan, num, vel) {
	var port = await JZZ().openMidiOut('LoopBe Internal MIDI').or();
	port.control(chan, num, vel)
}
exports.playNote = playNote;


var scr = [
`00000000000000000000000000000000000000101010000000000010001000000000001000100000000000100010000000000010101000000000000000000000`,
`00000000000000000000000000000000000000000011000000000000001100000000000000110000000000000011000000000000001100000000000000000000`,
`00000000000000000000000000000000000000121212000000000000001200000000001212120000000000120000000000000012121200000000000000000000`,
`00000000000000000000000000000000000000131313000000000000001300000000000013130000000000000013000000000013131300000000000000000000`,
`00000000000000000000000000000000000000140014000000000014001400000000001414140000000000000014000000000000001400000000000000000000`,
`00000000000000000000000000000000000000151515000000000015000000000000001515150000000000000015000000000015151500000000000000000000`,
`00000000000000000000000000000000000000161616000000000016000000000000001616160000000000160016000000000016161600000000000000000000`,
`00000000000000000000000000000000000000171717000000000000001700000000000000170000000000000017000000000000001700000000000000000000`,
`00000000000000000000000000000000000000181818000000000018001800000000001818180000000000180018000000000018181800000000000000000000`,
`00000000000000000000000000000000000000191919000000000019001900000000001919190000000000000019000000000000001900000000000000000000`,
`00000000000000000000000000000000001000151615000000110016001400000012001700130000001300180012000000140019101100000000000000000000`,
`10141414141414101413111111111314141114151514111414131110101113141011141515141110141311151511131414131115151113141011111010111110`,
`10101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010`,
`11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111`,
`12121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212`,
`13131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313`,
`14141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414`,
`15151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515`,
`16161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616`,
`17171717171717171717171717171717171717171717171717171717171717171717171717171717171717171717171717171717171717171717171717171717`,
`18181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818`,
`19191919191919191919191919191919191919191919191919191919191919191919191919191919191919191919191919191919191919191919191919191919`,
`19191919191919191818181818181818171717171717171716161616161616161515151515151515141414141414141413131313131313131212121212121212`,
`12001200120012001200120012001200120012001200120012001200120012001200120012001200120012001200120012001200120012001200120012001200`,
`15000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`,
`15150000000000001515000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`,
`15151500000000001515150000000000151515000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`,
`15151515000000001515151500000000151515150000000015151515000000000000000000000000000000000000000000000000000000000000000000000000`,
`15151515150000001515151515000000151515151500000015151515150000001515151515000000000000000000000000000000000000000000000000000000`,
`15151515151500001515151515150000151515151515000015151515151500001515151515150000151515151515000000000000000000000000000000000000`,
`15151515151515001515151515151500151515151515150015151515151515001515151515151500151515151515150015151515151515000000000000000000`,
`15151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515`,
`00190019001900191900190019001900001900190019001919001900190019000019001900190019190019001900190000190019001900191900190019001900`
]

async function sendScreen() {
	var port = await JZZ().openMidiOut('LoopBe Internal MIDI').or();
	scr.forEach((frame, index) => {
		setTimeout(() => {
			frame.match(/.{2}/g).forEach((num, index2, arr) => {
				// console.log(num[0], num[1])
				/*
				0 = Gray Slate
				1 = Gray Stone
				2 = White
				3 = Red
				4 = Orange
				5 = Yellow
				6 = Green
				7 = Cyan
				8 = Blue
				9 = Magenta
				*/
				parseInt(num[0]) == 1 ? port.noteOn(1, index2, parseInt(num[1])+1) : port.noteOff(1, index2, 127)
			})
		}, 1000 * index);
	})
}

function clamp(input) { return Math.round(Math.max(0, Math.min(127, input))) }
// sendScreenDebug()

exports.sendScreenDebug = sendScreenDebug
var sendScreenDebugCooldownActive = false
async function sendScreenDebug() {
	if( sendScreenDebugCooldownActive == true ){ return }
	sendScreenDebugCooldownActive = true
	setTimeout(() => { sendScreenDebugCooldownActive = false }, 30_000);
	var port = await JZZ().openMidiOut('LoopBe Internal MIDI').or();
	for (let index = 0; index < 64; index++) {
		setTimeout(() => {
			port.noteOn(1, index, 3 )
			// port.noteOn(1, index, clamp(index/127) )
		}, 100 * index);
	}
	setTimeout(() => {
		for (let index = 0; index < 64; index++) {
			setTimeout(() => {
				port.noteOff(1, index, 127)
			}, 100 * index);
		}
	}, 6500);

	setTimeout(() => { sendScreen() }, 6500 * 2);
}

// setInterval(() => {
// 	console.log('keep alive')
// }, 30000);